version: '3.8'

# ⚠️  AUDIO PROCESSING WARNING:
# Docker containers with insufficient resources will drop audio chunks when
# the processing queue becomes full (MAX_AUDIO_QUEUE_SIZE=10, lib.rs:54).
# Symptoms: "Dropped old audio chunk" in logs (lib.rs:330-333).
#
# RECOMMENDED RESOURCE ALLOCATION:
# - Memory: 8GB minimum per service (16GB total recommended)
# - CPU: 2+ cores per service
# - Monitor logs for audio drop warnings during operation

services:
  # Meeting Summarizer Python App (Windows/Linux)
  meeting-copilot-backend:
    build:
      context: .
      dockerfile: Dockerfile.app
    image: meeting-copilot-backend:latest
    container_name: meeting-copilot-backend
    restart: unless-stopped

    # Port mapping
    ports:
      - "${APP_PORT:-5167}:5167"

    # Environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - DATABASE_PATH=/app/data/meeting_minutes.db
      - DATABASE_URL=postgresql://neondb_owner:npg_3JYK7ySezjrT@ep-morning-truth-ahrz730e-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GROQ_API_KEY=${GROQ_API_KEY}
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - TRANSCRIPTION_PROVIDER=${TRANSCRIPTION_PROVIDER:-groq}
      - STORAGE_TYPE=${STORAGE_TYPE}
      - GCP_BUCKET_NAME=${GCP_BUCKET_NAME}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/gcp-service-account.json}
      - AUDIO_MERGE_SERVICE_URL=${AUDIO_MERGE_SERVICE_URL}
      - DELETE_PCM_AFTER_MERGE=${DELETE_PCM_AFTER_MERGE:-true}
      - AUDIO_CHUNK_PREFIX=${AUDIO_CHUNK_PREFIX:-pcm_chunks}

    # Add extra host for Docker Desktop compatibility
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Volume mounts
    volumes:
      # Local database directory (created by setup-db.sh)
      - ./data:/app/data
      - ./app:/app
      # Optional: mount GCP service account
      - ${GOOGLE_APPLICATION_CREDENTIALS_FILE:-./gcp-service-account.json}:/app/gcp-service-account.json:ro
      # Logs directory
      - meeting_app_logs:/app/logs
      # Optional: mount local .env file
      - ${LOCAL_ENV_FILE:-./.env}:/app/.env:ro

    # Health check
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5167/get-meetings" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Resource limits (optional)
    mem_limit: 2g
    mem_reservation: 512m

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Exclude from macOS profile
    profiles:
      - default

  # Meeting Summarizer Python App (macOS)
  meeting-copilot-backend-macos:
    build:
      context: .
      dockerfile: Dockerfile.app
    image: meeting-copilot-backend:latest
    container_name: meeting-copilot-backend
    restart: unless-stopped

    # Port mapping
    ports:
      - "${APP_PORT:-5167}:5167"

    # Environment variables
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - DATABASE_PATH=/app/data/meeting_minutes.db
      - DATABASE_URL=postgresql://neondb_owner:npg_3JYK7ySezjrT@ep-morning-truth-ahrz730e-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - STORAGE_TYPE=${STORAGE_TYPE}
      - GCP_BUCKET_NAME=${GCP_BUCKET_NAME}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-/app/gcp-service-account.json}
      - AUDIO_MERGE_SERVICE_URL=${AUDIO_MERGE_SERVICE_URL}
      - DELETE_PCM_AFTER_MERGE=${DELETE_PCM_AFTER_MERGE:-true}
      - AUDIO_CHUNK_PREFIX=${AUDIO_CHUNK_PREFIX:-pcm_chunks}

    # Add extra host for Docker Desktop compatibility
    extra_hosts:
      - "host.docker.internal:host-gateway"

    # Volume mounts
    volumes:
      # Local database directory (created by setup-db.sh)
      - ./data:/app/data
      - ./app:/app
      # Optional: mount GCP service account
      - ${GOOGLE_APPLICATION_CREDENTIALS_FILE:-./gcp-service-account.json}:/app/gcp-service-account.json:ro
      # Logs directory
      - meeting_app_logs:/app/logs
      # Optional: mount local .env file
      - ${LOCAL_ENV_FILE:-./.env}:/app/.env:ro

    # Health check
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5167/get-meetings" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Resource limits (optional)
    mem_limit: 2g
    mem_reservation: 512m

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # macOS profile only
    profiles:
      - macos

  # Optional: Web UI service (if you want a separate frontend)
  web-ui:
    image: nginx:alpine
    container_name: whisper-web-ui
    ports:
      - "${WEB_PORT:-80}:80"
    volumes:
      - ./web:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - meeting-copilot-backend
    profiles:
      - web

# Named volumes for persistent data
volumes:
  meeting_app_logs:
    driver: local

# Networks (optional)
networks:
  default:
    name: whisper-network
